<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>2023-03-14 19:26:34 +0800 +0800 on fayy&amp;fc</title><link>https://blog.thend03.com/date/2023-03-14-192634-+0800-+0800/</link><description>Recent content in 2023-03-14 19:26:34 +0800 +0800 on fayy&amp;fc</description><generator>Hugo -- gohugo.io</generator><language>zh</language><lastBuildDate>Tue, 14 Mar 2023 19:26:34 +0800</lastBuildDate><atom:link href="https://blog.thend03.com/date/2023-03-14-192634-+0800-+0800/index.xml" rel="self" type="application/rss+xml"/><item><title>InvalidProviderToken</title><link>https://blog.thend03.com/posts/apns%E6%8E%A8%E9%80%81%E5%A4%B1%E8%B4%A5/</link><pubDate>Tue, 14 Mar 2023 19:26:34 +0800</pubDate><guid>https://blog.thend03.com/posts/apns%E6%8E%A8%E9%80%81%E5%A4%B1%E8%B4%A5/</guid><description>背景 链接到标题 推送业务需要，需要由后台将消息通过apns(苹果统一推送服务)下发到用户的手机上，推送系统通知给用户。
后台架构 链接到标题 Java服务端使用了一个开源的库，使用这个开源的库将消息推送给apns。使用的p8证书，token鉴权方式。
使用的ios推送库git地址如下: https://github.com/jchambers/pushy
&amp;lt;dependency&amp;gt; &amp;lt;groupId&amp;gt;com.eatthepath&amp;lt;/groupId&amp;gt; &amp;lt;artifactId&amp;gt;pushy&amp;lt;/artifactId&amp;gt; &amp;lt;version&amp;gt;0.14.2&amp;lt;/version&amp;gt; &amp;lt;/dependency&amp;gt; apns client构建伪代码如下
//伪代码，实际需要p8证书文件转byte数组 byte[] certBytes = new byte[]{}; //伪代码，自己的p8证书的 teamId String apnsTeamId = &amp;#34;teamId&amp;#34;; //伪代码, 自己的p8证书的keyId String apnsKeyId = &amp;#34;keyId&amp;#34; //event_loop_group自己按需构建 EventLoopGroup EVENT_LOOP_GROUP = new NioEventLoopGroup(8, ConsumerTreadFactoryUtil.createPushFactory(&amp;#34;default&amp;#34;, &amp;#34;all&amp;#34;)); ApnsClient apnsClient = new ApnsClientBuilder() .setApnsServer(apnsHost) .setSigningKey(ApnsSigningKey.loadFromInputStream(new ByteArrayInputStream(certBytes), apnsTeamId, apnsKeyId)) .setEventLoopGroup(EVENT_LOOP_GROUP).setConcurrentConnections(16) .build(); 问题 链接到标题 测试环境运行了一段时间之后，再次推送ios消息之后，报错了，错误信息就是InvalidProviderToken。
先说结论，出现这个错误，就是teamId/keyId/bundleId/p8证书,这几个值对不上。 几个注意点
客户端生成regId的时候，使用的bundleId要和服务端推送使用的bundleId一致 teamId和keyId不要填反了 证书要使用正确 我这边的问题是teamId/keyId/bundleId是正确的，就是证书选错了，我这边有2个证书，一个是Auth_xx.p8，一个是Auth_xx1.p8。我实际要用的是Auth_xx.p8，结果服务端上传的时候，用了Auth_xx1.p8证书。
其中Auth_xx.p8，xx就是证书的keyId.
搜索一番之后，发现我填的keyId和证书的文件名称对不上，修改之后就正常了。 参考 链接到标题 https://github.com/node-apn/node-apn/issues/477#issuecomment-263531121 https://github.com/jchambers/pushy/discussions/915</description></item></channel></rss>