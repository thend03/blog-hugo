<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>metaspace-oom - fayy&amp;fc - A super concise theme for Hugo</title>
<meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="since"><meta name=description content="metaspace oom"><meta name=keywords content="Hugo,since,even"><meta name=generator content="Hugo 0.123.7 with theme even"><link rel=canonical href=https://blog.thend03.com/post/metaspace-oom/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.cb68f97bc9cece255d217346d970e3c62623408634e500c330a62fadabbbe77c.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="metaspace-oom"><meta property="og:description" content="metaspace oom"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.thend03.com/post/metaspace-oom/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-09-07T09:47:33+08:00"><meta property="article:modified_time" content="2023-09-07T09:47:33+08:00"><meta itemprop=name content="metaspace-oom"><meta itemprop=description content="metaspace oom"><meta itemprop=datePublished content="2023-09-07T09:47:33+08:00"><meta itemprop=dateModified content="2023-09-07T09:47:33+08:00"><meta itemprop=wordCount content="5406"><meta itemprop=keywords content="jvm,oom,"><meta name=twitter:card content="summary"><meta name=twitter:title content="metaspace-oom"><meta name=twitter:description content="metaspace oom"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>fayy&amp;fc</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>首页</li></a><a href=/post/><li class=mobile-menu-item>归档</li></a><a href=/tags/><li class=mobile-menu-item>标签</li></a><a href=/categories/><li class=mobile-menu-item>分类</li></a><a href=/about><li class=mobile-menu-item>关于</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>fayy&amp;fc</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>首页</a></li><li class=menu-item><a class=menu-item-link href=/post/>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-item-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-item-link href=/about>关于</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>metaspace-oom</h1><div class=post-meta><span class=post-time>2023-09-07</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#问题背景>问题背景</a></li><li><a href=#前置知识>前置知识</a><ul><li><a href=#启动参数>启动参数</a></li><li><a href=#metaspace里有什么>Metaspace里有什么</a></li><li><a href=#排查手段>排查手段</a></li><li><a href=#jvm排查>JVM排查</a></li><li><a href=#dump分析>dump分析</a></li><li><a href=#arthas>arthas</a></li></ul></li><li><a href=#实际排查过程>实际排查过程</a><ul><li><a href=#问题修复>问题修复</a></li></ul></li><li><a href=#问题复现>问题复现</a><ul><li><a href=#测试代码>测试代码</a></li><li><a href=#修复验证>修复验证</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考资料>参考资料</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=问题背景>问题背景</h2><p>生产环境有机器产生了oom，一开始怀疑是heap oom，因为之前配置了发生oom，自动进行dump，所以分析了dump文件之后，发现4g的heap，最终dump只有300多m，没有分析出有用的内容。</p><p>后来又一次oom之后，终于在容器控制台发现了错误根因，是Metaspace发生了oom。</p><p>所以着重分析下Metaspace为什么会oom。</p><h2 id=前置知识>前置知识</h2><h3 id=启动参数>启动参数</h3><p>先看下启动参数，看下JVM具体的参数配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>-</span><span class=n>Xmx4096M</span> <span class=o>-</span><span class=n>Xms4096M</span> <span class=o>-</span><span class=n>Xmn2048M</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>MaxMetaspaceSize</span><span class=o>=</span><span class=mi>512</span><span class=n>M</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>MetaspaceSize</span><span class=o>=</span><span class=mi>512</span><span class=n>M</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>UseConcMarkSweepGC</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>UseCMSInitiatingOccupancyOnly</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>CMSInitiatingOccupancyFraction</span><span class=o>=</span><span class=mi>70</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>ExplicitGCInvokesConcurrentAndUnloadsClasses</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>CMSClassUnloadingEnabled</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>ParallelRefProcEnabled</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>CMSScavengeBeforeRemark</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>HeapDumpOnOutOfMemoryError</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>ErrorFile</span><span class=o>=/</span><span class=n>data</span><span class=o>/</span><span class=n>logs</span><span class=o>/</span><span class=n>hs_err_pid</span><span class=o>%</span><span class=n>p</span><span class=o>.</span><span class=n>log</span> <span class=o>-</span><span class=n>Xloggc</span><span class=p>:</span><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>shm</span><span class=o>/</span><span class=n>gc</span><span class=o>.</span><span class=n>log</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>HeapDumpPath</span><span class=o>=/</span><span class=n>data</span><span class=o>/</span><span class=n>logs</span><span class=o>/</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintGCDetails</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintGCDateStamps</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintClassHistogramBeforeFullGC</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintClassHistogramAfterFullGC</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintCommandLineFlags</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintGCApplicationConcurrentTime</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintGCApplicationStoppedTime</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintTenuringDistribution</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintHeapAtGC</span> <span class=o>-</span><span class=n>Ddubbo</span><span class=o>.</span><span class=n>reference</span><span class=o>.</span><span class=n>check</span><span class=o>=</span><span class=bp>false</span> 
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>UnlockDiagnosticVMOptions</span>
</span></span></code></pre></td></tr></table></div></div><p>这个是公司默认的jvm参数，可以看到，堆最大是4g，metaspace最大是512m，metaspace给的空间已经很大了，但还是发生了oom。</p><p>关于metaspace的大小的配置项，我们后面再提一下具体含义。</p><h3 id=metaspace里有什么>Metaspace里有什么</h3><p>分析Metaspace oom之前，先确认下metaspace里会有哪些东西。jdk1.8相比1.7，移除了perm gen，把class,method,constant pool等内容移到了metaspace，单独的一块区域，和机器内存直接相关，不受堆管控。</p><p>在底层，MetaSpace 主要由 Klass Metaspace 和 NoKlass Metaspace 两大部分组成。</p><p>Klass MetaSpace： 就是用来存 Klass 的，就是 Class 文件在 JVM 里的运行时数据结构，这部分默认放在 Compressed Class Pointer Space 中，是一块连续的内存区域，紧接着 Heap。</p><p>Compressed Class Pointer Space 不是必须有的，如果设置了 -XX:-UseCompressedClassPointers，或者 -Xmx 设置大于 32 G，就不会有这块内存，这种情况下 Klass 都会存在 NoKlass Metaspace 里。</p><p>NoKlass MetaSpace： 专门来存 Klass 相关的其他的内容，比如 Method，ConstantPool 等，可以由多块不连续的内存组成。虽然叫做 NoKlass Metaspace，但是也其实可以存 Klass 的内容，上面已经提到了对应场景。</p><p>MetaSpace 的对象为什么无法释放，我们看下面两点</p><ul><li><strong>MetaSpace 内存管理：</strong> 类和其元数据的生命周期与其对应的类加载器相同，只要类的类加载器是存活的，在 Metaspace 中的类元数据也是存活的，不能被回收。每个加载器有单独的存储空间，通过 ClassLoaderMetaspace 来进行管理 SpaceManager* 的指针，相互隔离的。</li><li><strong>MetaSpace 弹性伸缩：</strong> 由于 MetaSpace 空间和 Heap 并不在一起，所以这块的空间可以不用设置或者单独设置，一般情况下避免 MetaSpace 耗尽 VM 内存都会设置一个 MaxMetaSpaceSize，在运行过程中，如果实际大小小于这个值，JVM 就会通过 <code>-XX:MinMetaspaceFreeRatio</code> 和 <code>-XX:MaxMetaspaceFreeRatio</code> 两个参数动态控制整个 MetaSpace 的大小，这个方法会在 CMSCollector 和 G1CollectorHeap 等几个收集器执行 GC 时调用。这个里面会根据 <code>used_after_gc</code>，<code>MinMetaspaceFreeRatio</code> 和 <code>MaxMetaspaceFreeRatio</code> 这三个值计算出来一个新的 <code>_capacity_until_GC</code> 值（水位线）。然后根据实际的 <code>_capacity_until_GC</code> 值使用 <code>MetaspaceGC::inc_capacity_until_GC()</code> 和 <code>MetaspaceGC::dec_capacity_until_GC()</code> 进行 expand 或 shrink。</li></ul><p>为了避免弹性伸缩带来的额外 GC 消耗，一般要将 <code>-XX:MetaSpaceSize</code> 和 <code>-XX:MaxMetaSpaceSize</code> 两个值设置为固定的，但是这样也会导致在空间不够的时候无法扩容，然后频繁地触发 GC，最终 OOM。</p><p>所以关键原因就是 ClassLoader 不停地在内存中 load 了新的 Class ，一般这种问题都发生在动态类加载等情况上。</p><p>可能出现问题的点有如下几个</p><ul><li>groovy动态加载类</li><li>反射使用不当频繁创建类</li><li>Orika 的 classMap</li><li>JSON 的 ASMSerializer</li></ul><p>基本都集中在反射、Javasisit 字节码增强、CGLIB 动态代理、OSGi 自定义类加载器等的技术点上。</p><h3 id=排查手段>排查手段</h3><p>有了上面的背景之后，我们排查方向分为2部分，一部分是看发版记录，最近有哪些改动，哪些地方可能会频繁创建类，二是从jvm层面排查。我们重点说一下jvm层面的排查方向。</p><p><em><strong>注意事项: 写这篇文章的时候，问题已经解决，所以部分数据不是出问题时采集的数据，是为了写文章使用对应的排查工具生成的数据，具体位置处会标明数据来源和时机</strong></em></p><h3 id=jvm排查>JVM排查</h3><p>jdk自带的排查工具，我们可以用的有jps,jstat,jmap等</p><p>其中jmap看的是堆的内存大小和分配</p><p>jstat可以看gc相关信息.</p><p>gc.log里的gc日志也可以辅助我们排查</p><h4 id=jmap>jmap</h4><p>jmap -heap pid的信息如下，这个可以辅助我们看下堆内分代的内存使用情况，当然这个对我们的排查帮助不大，下面看一下命令效果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Attaching to process ID 5311, please wait...
</span></span><span class=line><span class=cl>Debugger attached successfully.
</span></span><span class=line><span class=cl>Server compiler detected.
</span></span><span class=line><span class=cl>JVM version is 25.73-b02
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>using parallel threads in the new generation.
</span></span><span class=line><span class=cl>using thread-local object allocation.
</span></span><span class=line><span class=cl>Concurrent Mark-Sweep GC
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Heap Configuration:
</span></span><span class=line><span class=cl>   MinHeapFreeRatio         = 40
</span></span><span class=line><span class=cl>   MaxHeapFreeRatio         = 70
</span></span><span class=line><span class=cl>   MaxHeapSize              = 4294967296 (4096.0MB)
</span></span><span class=line><span class=cl>   NewSize                  = 2147483648 (2048.0MB)
</span></span><span class=line><span class=cl>   MaxNewSize               = 2147483648 (2048.0MB)
</span></span><span class=line><span class=cl>   OldSize                  = 2147483648 (2048.0MB)
</span></span><span class=line><span class=cl>   NewRatio                 = 2
</span></span><span class=line><span class=cl>   SurvivorRatio            = 8
</span></span><span class=line><span class=cl>   MetaspaceSize            = 536870912 (512.0MB)
</span></span><span class=line><span class=cl>   CompressedClassSpaceSize = 1073741824 (1024.0MB)
</span></span><span class=line><span class=cl>   MaxMetaspaceSize         = 536870912 (512.0MB)
</span></span><span class=line><span class=cl>   G1HeapRegionSize         = 0 (0.0MB)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Heap Usage:
</span></span><span class=line><span class=cl>New Generation (Eden + 1 Survivor Space):
</span></span><span class=line><span class=cl>   capacity = 1932787712 (1843.25MB)
</span></span><span class=line><span class=cl>   used     = 735313536 (701.2496337890625MB)
</span></span><span class=line><span class=cl>   free     = 1197474176 (1142.0003662109375MB)
</span></span><span class=line><span class=cl>   38.04419551276617% used
</span></span><span class=line><span class=cl>Eden Space:
</span></span><span class=line><span class=cl>   capacity = 1718091776 (1638.5MB)
</span></span><span class=line><span class=cl>   used     = 733845856 (699.8499450683594MB)
</span></span><span class=line><span class=cl>   free     = 984245920 (938.6500549316406MB)
</span></span><span class=line><span class=cl>   42.71284376370823% used
</span></span><span class=line><span class=cl>From Space:
</span></span><span class=line><span class=cl>   capacity = 214695936 (204.75MB)
</span></span><span class=line><span class=cl>   used     = 1467680 (1.399688720703125MB)
</span></span><span class=line><span class=cl>   free     = 213228256 (203.35031127929688MB)
</span></span><span class=line><span class=cl>   0.683608654800061% used
</span></span><span class=line><span class=cl>To Space:
</span></span><span class=line><span class=cl>   capacity = 214695936 (204.75MB)
</span></span><span class=line><span class=cl>   used     = 0 (0.0MB)
</span></span><span class=line><span class=cl>   free     = 214695936 (204.75MB)
</span></span><span class=line><span class=cl>   0.0% used
</span></span><span class=line><span class=cl>concurrent mark-sweep generation:
</span></span><span class=line><span class=cl>   capacity = 2147483648 (2048.0MB)
</span></span><span class=line><span class=cl>   used     = 613751744 (585.3192749023438MB)
</span></span><span class=line><span class=cl>   free     = 1533731904 (1462.6807250976562MB)
</span></span><span class=line><span class=cl>   28.580042719841003% used
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>66527 interned Strings occupying 7048176 bytes.
</span></span></code></pre></td></tr></table></div></div><p>还有一个命令是jmap -histo pid，这个可以看堆内存活的对象类型和实例数量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> num     #instances         #bytes  class name
</span></span><span class=line><span class=cl>----------------------------------------------
</span></span><span class=line><span class=cl>   1:       5478775      506824136  [C
</span></span><span class=line><span class=cl>   2:       1421313      315369496  [B
</span></span><span class=line><span class=cl>   3:       3791992       91007808  java.lang.String
</span></span><span class=line><span class=cl>   4:       2593077       82978464  java.util.HashMap$Node
</span></span><span class=line><span class=cl>   5:        730043       78351624  [I
</span></span><span class=line><span class=cl>   6:       1393624       67623928  [Ljava.lang.Object;
</span></span><span class=line><span class=cl>   7:        712992       62743296  java.lang.reflect.Method
</span></span><span class=line><span class=cl>   8:        317758       48979560  [Ljava.util.HashMap$Node;
</span></span><span class=line><span class=cl>   9:        178237       32795608  com.fasterxml.jackson.core.json.UTF8StreamJsonParser
</span></span><span class=line><span class=cl>  10:        513502       20540080  java.util.LinkedHashMap$Entry
</span></span><span class=line><span class=cl>  11:        639968       20478976  com.mysql.cj.conf.BooleanProperty
</span></span><span class=line><span class=cl>  12:        941240       18059848  [Ljava.lang.Class;
</span></span><span class=line><span class=cl>  13:        353510       16968480  java.util.HashMap
</span></span><span class=line><span class=cl>  14:        241178       13505968  sun.nio.cs.UTF_8$Encoder
</span></span><span class=line><span class=cl>  15:        539462       12947088  java.lang.StringBuilder
</span></span><span class=line><span class=cl>  16:        178448       12848256  com.fasterxml.jackson.databind.deser.DefaultDeserializationContext$Impl
</span></span><span class=line><span class=cl>  17:        218814       12253584  com.fasterxml.jackson.core.io.IOContext
</span></span></code></pre></td></tr></table></div></div><h4 id=jstat>jstat</h4><p>使用jstat观察gc和metaspace的使用情况，jstat主要输出各个区域的使用量比例(<em><strong>写这篇文章的时候问题已修复，所以metaspace使用占比比较平稳</strong></em>)</p><p><code>jstat -gcutil 5311</code> 这个命令以1000ms为间隔，输出pid 5311的进程的gc情况，从这里可以看出metaspace的使用比例的变化</p><p>比如s0是survivo 0当前空间的已使用比例，s1的survivo 1当前空间的已使用比例，E是eden区的已使用比例，O是old gen的已使用比例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   
</span></span><span class=line><span class=cl>  0.00   1.04  57.32  27.40  92.59  86.14 125511 1969.952    28    5.062 1975.014
</span></span><span class=line><span class=cl>  0.00   1.04  78.69  27.40  92.59  86.14 125511 1969.952    28    5.062 1975.014
</span></span><span class=line><span class=cl>  0.00   1.04  97.81  27.40  92.59  86.14 125511 1969.952    28    5.062 1975.014
</span></span><span class=line><span class=cl>  0.98   0.00  32.47  27.40  92.59  86.14 125512 1969.968    28    5.062 1975.031
</span></span><span class=line><span class=cl>  0.98   0.00  66.19  27.40  92.59  86.14 125512 1969.968    28    5.062 1975.031
</span></span><span class=line><span class=cl>  0.98   0.00  91.34  27.40  92.59  86.14 125512 1969.968    28    5.062 1975.031
</span></span><span class=line><span class=cl>  0.00   0.81  17.07  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span class=line><span class=cl>  0.00   0.81  39.36  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span class=line><span class=cl>  0.00   0.81  60.87  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span class=line><span class=cl>  0.00   0.81  89.84  27.41  92.59  86.14 125513 1969.980    28    5.062 1975.042
</span></span><span class=line><span class=cl>  0.89   0.00   9.76  27.42  92.59  86.14 125514 1969.995    28    5.062 1975.058
</span></span><span class=line><span class=cl>  0.89   0.00  25.07  27.42  92.59  86.14 125514 1969.995    28    5.062 1975.058
</span></span><span class=line><span class=cl>  0.89   0.00  44.26  27.42  92.59  86.14 125514 1969.995    28    5.062 1975.058
</span></span></code></pre></td></tr></table></div></div><h4 id=gclog>gc.log</h4><p>另一个就是从gc.log里查看metaspace的日志,下面一段日志是gc前和gc后各个区域的内存变化</p><p>可以观察下heap before gc和heap after gc2处的metaspace空间使用变化(<em><strong>此处是问题解决后的gc.log,仅供参考</strong></em>)</p><p>metaspace数据如下，可以看到距离512m还有足够的空间，注意此处是问题解决后的数据，仅供排查参考</p><ul><li>used 176869K， 已使用大概是172m</li><li>capacity 189800K， 容量大概是185m</li><li>committed 190848K，已提交大概是186m</li><li>reserved 1216512K，保留大概是1188m</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2023-09-12T09:03:08.449+0800: 1249459.698: Total time for which application threads were stopped: 0.0195137 seconds, Stopping threads took: 0.0001738 seconds
</span></span><span class=line><span class=cl>2023-09-12T09:03:11.392+0800: 1249462.641: Application time: 2.9429699 seconds
</span></span><span class=line><span class=cl>2023-09-12T09:03:11.396+0800: 1249462.646: Total time for which application threads were stopped: 0.0046629 seconds, Stopping threads took: 0.0002150 seconds
</span></span><span class=line><span class=cl>2023-09-12T09:03:11.397+0800: 1249462.646: Application time: 0.0000922 seconds
</span></span><span class=line><span class=cl>2023-09-12T09:03:11.400+0800: 1249462.649: Total time for which application threads were stopped: 0.0034414 seconds, Stopping threads took: 0.0001087 seconds
</span></span><span class=line><span class=cl>2023-09-12T09:03:14.304+0800: 1249465.553: Application time: 2.9035482 seconds
</span></span><span class=line><span class=cl>{Heap before GC invocations=130961 (full 14):
</span></span><span class=line><span class=cl> par new generation   total 1887488K, used 1679309K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000)
</span></span><span class=line><span class=cl>  eden space 1677824K, 100% used [0x00000006c0000000, 0x0000000726680000, 0x0000000726680000)
</span></span><span class=line><span class=cl>  from space 209664K,   0% used [0x0000000733340000, 0x00000007334b34a0, 0x0000000740000000)
</span></span><span class=line><span class=cl>  to   space 209664K,   0% used [0x0000000726680000, 0x0000000726680000, 0x0000000733340000)
</span></span><span class=line><span class=cl> concurrent mark-sweep generation total 2097152K, used 1209833K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000)
</span></span><span class=line><span class=cl> Metaspace       used 176869K, capacity 189800K, committed 190848K, reserved 1216512K
</span></span><span class=line><span class=cl>  class space    used 19973K, capacity 22145K, committed 23168K, reserved 1048576K
</span></span><span class=line><span class=cl>2023-09-12T09:03:14.307+0800: 1249465.557: [GC (Allocation Failure) 2023-09-12T09:03:14.307+0800: 1249465.557: [ParNew
</span></span><span class=line><span class=cl>Desired survivor size 107347968 bytes, new threshold 6 (max 6)
</span></span><span class=line><span class=cl>- age   1:     674280 bytes,     674280 total
</span></span><span class=line><span class=cl>- age   2:     177208 bytes,     851488 total
</span></span><span class=line><span class=cl>- age   3:     238904 bytes,    1090392 total
</span></span><span class=line><span class=cl>- age   4:     191384 bytes,    1281776 total
</span></span><span class=line><span class=cl>- age   5:      38080 bytes,    1319856 total
</span></span><span class=line><span class=cl>- age   6:      40232 bytes,    1360088 total
</span></span><span class=line><span class=cl>: 1679309K-&gt;1868K(1887488K), 0.0143320 secs] 2889142K-&gt;1211742K(3984640K), 0.0146560 secs] [Times: user=0.03 sys=0.01, real=0.01 secs] 
</span></span><span class=line><span class=cl>Heap after GC invocations=130962 (full 14):
</span></span><span class=line><span class=cl> par new generation   total 1887488K, used 1868K [0x00000006c0000000, 0x0000000740000000, 0x0000000740000000)
</span></span><span class=line><span class=cl>  eden space 1677824K,   0% used [0x00000006c0000000, 0x00000006c0000000, 0x0000000726680000)
</span></span><span class=line><span class=cl>  from space 209664K,   0% used [0x0000000726680000, 0x0000000726853010, 0x0000000733340000)
</span></span><span class=line><span class=cl>  to   space 209664K,   0% used [0x0000000733340000, 0x0000000733340000, 0x0000000740000000)
</span></span><span class=line><span class=cl> concurrent mark-sweep generation total 2097152K, used 1209874K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000)
</span></span><span class=line><span class=cl> Metaspace       used 176869K, capacity 189800K, committed 190848K, reserved 1216512K
</span></span><span class=line><span class=cl>  class space    used 19973K, capacity 22145K, committed 23168K, reserved 1048576K
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h4 id=jcmd>jcmd</h4><p>最后一个可用的jvm工具就是cmd，使用jcmd打印下class数量，看下哪些包下的类增长比较快</p><p>使用命令如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jcmd &lt;PID&gt; GC.class_stats|awk &#39;{print$13}&#39;|sed  &#39;s/\(.*\)\.\(.*\)/\1/g&#39;|sort |uniq -c|sort -nrk1
</span></span></code></pre></td></tr></table></div></div><p>实际进程打印如下,可以看到最多的是sun.reflect包下的class最多</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>   2283 sun.reflect
</span></span><span class=line><span class=cl>    416 com.xx.xx.xx.xx.impl
</span></span><span class=line><span class=cl>    316 java.lang.invoke
</span></span><span class=line><span class=cl>    306 com.sun.proxy
</span></span><span class=line><span class=cl>    275 reactor.core.publisher
</span></span><span class=line><span class=cl>    268 java.util
</span></span><span class=line><span class=cl>    198 com.google.common.collect
</span></span><span class=line><span class=cl>    189 com.google.protobuf
</span></span><span class=line><span class=cl>    181 io.netty.channel
</span></span><span class=line><span class=cl>    174 java.lang
</span></span></code></pre></td></tr></table></div></div><h3 id=dump分析>dump分析</h3><p>dump 快照之后通过 JProfiler 或 MAT 观察 Classes 的 Histogram (直方图) ，这个估计得深厚的功力才能看出来</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533501.png alt=image-20230912134908936></p><h3 id=arthas>arthas</h3><p>arthas也有很多的命令可以帮助排查，比如dashboard，可以看metaspace区的内存占用，vmtool可以查看具体的class</p><p>如下是dashborad命令，可以看到metaspace的使用量</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533082.png alt=image-20230912135302354></p><p>可以使用vmtool，匹配指定包名的class</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>vmtool</span> <span class=o>--</span><span class=n>action</span> <span class=n>getInstances</span> <span class=o>--</span><span class=n>className</span> <span class=n>sun</span><span class=o>.</span><span class=n>reflect</span><span class=o>.*</span> <span class=o>--</span><span class=n>limit</span> <span class=mi>100</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533919.png alt=image-20230912135822213></p><p>可以使用transform，有类加载的时候就会触发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>watch java.lang.instrument.ClassFileTransformer transform &#39;{params,returnObj,throwExp}&#39;  -n 5  -x 3
</span></span></code></pre></td></tr></table></div></div><p>也可以跟踪下class init</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>stack sun.reflect.DelegatingClassLoader &lt;init&gt;  -n 5
</span></span></code></pre></td></tr></table></div></div><h2 id=实际排查过程>实际排查过程</h2><p>前面介绍了一些关于metaspace的知识，也介绍了一些排查方向，接下来介绍下实际排查过程</p><p>接到告警之后，查看进程，发现了metaspace oom的错误，于是开始往metaspace oom的方向开始排查</p><p>经过一通google/baidu之后，发现了如上介绍的一些方向和手段</p><p>首先是看了美团的文章<a href=https://tech.meituan.com/2020/11/12/java-9-cms-gc.html>场景三：MetaSpace 区 OOM</a></p><p>发现可以使用jcmd命令进行排查，看下哪个包的class比较多，执行以下命令，得到如下的结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jcmd 5311 GC.class_stats|awk &#39;{print$13}&#39;|sed  &#39;s/\(.*\)\.\(.*\)/\1/g&#39;|sort |uniq -c|sort -nrk1|head -n 10
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> 2294 sun.reflect
</span></span><span class=line><span class=cl>    416 com.xx.impl
</span></span><span class=line><span class=cl>    316 java.lang.invoke
</span></span><span class=line><span class=cl>    316 com.sun.proxy
</span></span><span class=line><span class=cl>    275 reactor.core.publisher
</span></span><span class=line><span class=cl>    268 java.util
</span></span><span class=line><span class=cl>    198 com.google.common.collect
</span></span><span class=line><span class=cl>    189 com.google.protobuf
</span></span><span class=line><span class=cl>    181 io.netty.channel
</span></span><span class=line><span class=cl>    174 java.lang
</span></span></code></pre></td></tr></table></div></div><p>多次执行jcmd之后，发现sun.reflect包下的class比较多，且有增长，于是把目光放在了sun.reflect上。</p><p>以为是反射用的不当导致的，然后使用arthas，分析了dashboard以及使用了vmtool查看sun.reflect包的instance。</p><p>当时使用dashboard分析，metaspace上涨的非常的快，然后使用vmtool命令查看sun.reflect</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>vmtool</span> <span class=o>--</span><span class=n>action</span> <span class=n>getInstances</span> <span class=o>--</span><span class=n>className</span> <span class=n>sun</span><span class=o>.</span><span class=n>reflect</span><span class=o>.*</span> <span class=o>--</span><span class=n>limit</span> <span class=mi>100</span>
</span></span></code></pre></td></tr></table></div></div><p>执行结果类似下图</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131533382.png alt=image-20230912135822213></p><p>分析发现里面有mytabis，也有自己调用产生的反射，但是不足以导致metaspace oom</p><p>后来想到了加上如下2个参数,用于打印类加载、卸载日志</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>TraceClassLoading</span> <span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>TraceClassUnloading</span>
</span></span></code></pre></td></tr></table></div></div><p>由于发布系统默认没打nohup日志，所以在这里走了点弯路，类加载、卸载信息没打到日志里，后来上机器手动用nohup java -jar xx.jar &之后，发现了端倪</p><p>可以看到启动之后，打了比较多的类似下面的这些日志，可以初步判断是com.googlecode.aviator.Expression使用不当造成的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Loaded Script_1691559755244_2757/2021240514 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559755339_2758/6228193 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559755492_2759/419920034 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559756493_2760/1460748148 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559756500_2761/520805009 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559756506_2762/398664510 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559756573_2763/306461935 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559756577_2764/1116508142 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559756791_2765/870354750 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559756799_2766/1661127610 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559756812_2767/1883979577 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559757019_2768/1281538781 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559757332_2769/589742334 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559757338_2770/1560860126 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559757977_2771/213218340 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559758313_2772/505164301 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559758318_2773/601453331 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759007_2774/1011764766 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759014_2775/338373159 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759146_2776/1714310047 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759154_2777/1663245165 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759227_2778/797537408 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759234_2779/551097430 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759553_2780/594411270 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759559_2781/1720465741 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759586_2782/215181464 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759601_2783/2036721542 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759797_2784/1723282218 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759802_2785/953430028 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759942_2786/847216521 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559759949_2787/1763495463 from com.googlecode.aviator.Expression]
</span></span><span class=line><span class=cl>[Loaded Script_1691559760350_2788/47562916 from com.googlecode.aviator.Expression]
</span></span></code></pre></td></tr></table></div></div><p>跟着com.googlecode.aviator.Expression这个类，发现可能造成异常的代码如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Expression expression = AviatorEvaluator.compile(ruleExpressProcessed);
</span></span></code></pre></td></tr></table></div></div><p>这个还有一个重载方法,是否缓存</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static Expression compile(String expression, boolean cached) {
</span></span><span class=line><span class=cl>        return getInstance().compile(expression, cached);
</span></span><span class=line><span class=cl>    }
</span></span></code></pre></td></tr></table></div></div><p>跟踪代码，最后会发现cached字段会影响classloader的获取，如果cached=true,则会使用已缓存的classloader，如果false每次都会new 一个新的classloader</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>com.googlecode.aviator.AviatorEvaluatorInstance#newCodeGenerator(java.lang.String, boolean)
</span></span></code></pre></td></tr></table></div></div><h3 id=问题修复>问题修复</h3><p>将cached设置为true,metaspace使用率就很平稳了，不会出现高频的类加载和卸载情况。</p><h2 id=问题复现>问题复现</h2><p>本打算在本地复现下这个问题的，但是本地能gc掉，生产环境由于每次2-3天才会发生oom，所以没有发现oom的时候，metaspace里有哪些元素，可以看下本地验证过程和现象，帮助理解</p><h3 id=测试代码>测试代码</h3><p>maven依赖</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>        &lt;dependency&gt;
</span></span><span class=line><span class=cl>            &lt;groupId&gt;com.googlecode.aviator&lt;/groupId&gt;
</span></span><span class=line><span class=cl>            &lt;artifactId&gt;aviator&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>            &lt;version&gt;5.2.5&lt;/version&gt;
</span></span><span class=line><span class=cl>        &lt;/dependency&gt;
</span></span></code></pre></td></tr></table></div></div><p>jvm参数</p><p>堆设置的比较大,metaspace只设置了128m</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>-</span><span class=n>Xmx4096M</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>Xms4096M</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>Xmn2048M</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>MaxMetaspaceSize</span><span class=o>=</span><span class=mi>128</span><span class=n>M</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>MetaspaceSize</span><span class=o>=</span><span class=mi>128</span><span class=n>M</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>UseConcMarkSweepGC</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>UseCMSInitiatingOccupancyOnly</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>CMSInitiatingOccupancyFraction</span><span class=o>=</span><span class=mi>70</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>ExplicitGCInvokesConcurrentAndUnloadsClasses</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>CMSClassUnloadingEnabled</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>ParallelRefProcEnabled</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>CMSScavengeBeforeRemark</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>HeapDumpOnOutOfMemoryError</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>ErrorFile</span><span class=o>=/</span><span class=n>data</span><span class=o>/</span><span class=n>logs</span><span class=o>/</span><span class=n>hs_err_pid</span><span class=o>%</span><span class=n>p</span><span class=o>.</span><span class=n>log</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>Xloggc</span><span class=p>:</span><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>shm</span><span class=o>/</span><span class=n>gc</span><span class=o>.</span><span class=n>log</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>HeapDumpPath</span><span class=o>=/</span><span class=n>data</span><span class=o>/</span><span class=n>logs</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintGCDetails</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintGCDateStamps</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintClassHistogramBeforeFullGC</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintClassHistogramAfterFullGC</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintCommandLineFlags</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintGCApplicationConcurrentTime</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintGCApplicationStoppedTime</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintTenuringDistribution</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>PrintHeapAtGC</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>Ddubbo</span><span class=o>.</span><span class=n>reference</span><span class=o>.</span><span class=n>check</span><span class=o>=</span><span class=bp>false</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>UnlockDiagnosticVMOptions</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=n>NativeMemoryTracking</span><span class=o>=</span><span class=n>detail</span>
</span></span><span class=line><span class=cl><span class=o>//</span><span class=k>class</span> <span class=n>loading</span> <span class=n>unloading</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>TraceClassLoading</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=n>XX</span><span class=p>:</span><span class=o>+</span><span class=n>TraceClassUnloading</span>
</span></span></code></pre></td></tr></table></div></div><p>使用多线程去并发访问</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static void main(String[] args) {
</span></span><span class=line><span class=cl>        ThreadFactory threadFactory = new ThreadFactoryBuilder().setNameFormat(&#34;test-pool-%d&#34;).build();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        ThreadPoolExecutor executor = new ThreadPoolExecutor(50, 50, 1, TimeUnit.SECONDS, new LinkedBlockingQueue&lt;&gt;(50), threadFactory);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        for (int i = 0; i &lt; 32; i++) {
</span></span><span class=line><span class=cl>            executor.execute(() -&gt; {
</span></span><span class=line><span class=cl>                while (true) {
</span></span><span class=line><span class=cl>                    try {
</span></span><span class=line><span class=cl>                        String rule = &#34;field01+ field02&#34;;
</span></span><span class=line><span class=cl>                        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
</span></span><span class=line><span class=cl>                        int random1 = new Random().nextInt();
</span></span><span class=line><span class=cl>                        int random2 = new Random().nextInt();
</span></span><span class=line><span class=cl>                        map.put(&#34;field01&#34;, random1);
</span></span><span class=line><span class=cl>                        map.put(&#34;field02&#34;, random2);
</span></span><span class=line><span class=cl>                        Expression compiledExp = AviatorEvaluator.compile(rule);
</span></span><span class=line><span class=cl>                        Object obj = compiledExp.execute(map);
</span></span><span class=line><span class=cl>                        System.out.println(obj);
</span></span><span class=line><span class=cl>                    } catch (Exception e) {
</span></span><span class=line><span class=cl>                        e.printStackTrace();
</span></span><span class=line><span class=cl>                    }
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>            });
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    }
</span></span></code></pre></td></tr></table></div></div><p>控制台也输出了同样的日志</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309131532929.png alt=image-20230912163302034></p><p>然后使用jconsole连到jvm上观察内存使用情况</p><p>首先是metaspace的使用情况，最高是到50m，然后gc掉，持续这一过程，说明metaspace使用量在上升，但是能gc的掉，而且不会触发阈值。</p><p>生产上发生oom，可能有流量因素，访问量比本地模拟的大。</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141028935.png alt=image-20230914102800888></p><p>在看下类的加载卸载情况，程序运行了1个半小时，加载和卸载数量差不多持平，大概6529万次，可以发现类是一直在加载，但是本地模拟的情况下，卸载的也快，生产上的具体细节由于网络隔离问题，无法模拟出，仅能根据加载数量看出类加载数量异常了，这块代码是有问题的</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141026106.png alt=image-20230914102639065></p><p>概览里可以看到已加载的类的数量，在一个区间范围内波动，一边加载一边卸载</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141308641.png alt=image-20230914130832590></p><h3 id=修复验证>修复验证</h3><p>代码修改如下，将cached设置为true</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Expression compiledExp = AviatorEvaluator.compile(rule,true);
</span></span></code></pre></td></tr></table></div></div><p>概览数据如下，可以发现类只加载了2000多个就平稳了，不会加载新的class</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141322257.png alt=image-20230914132245192></p><p>metaspace使用量稳定在13m,不会波动</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141323256.png alt=image-20230914132321198></p><p>类在加载了2274个之后保持稳定，没有新增</p><p><img src=https://cdn.jsdelivr.net/gh/thend03/mdPic/picGo/202309141323853.png alt=image-20230914132359797></p><p>根据修改之后的现象判断，造成问题的原因就是每次都会new classloader，导致类频繁加载卸载，叠加生产流量不可控，极端情况可能就会导致oom</p><h2 id=总结>总结</h2><p>由于未设置metaspace区监控，具体的原因暂未发现，比如Metaspace里的class数量占比，分类等。</p><p>修复之后再上线，使用arthas观察metaspace使用量，发现metaspace区域内存使用量。</p><p>关于metaspace的可用资料，相比于堆内存的oom来说，比较少，所以排查下来也没有那么顺利，不过经过这次问题排查，对metaspace有了一定的了解，下次再排查问题时，可以有更好的切入方向了</p><h2 id=参考资料>参考资料</h2><ul><li><a href=https://tech.meituan.com/2020/11/12/java-9-cms-gc.html>场景三：MetaSpace 区 OOM</a></li><li><a href=https://www.javadoop.com/post/metaspace>深入理解堆外内存metaspace</a></li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>since</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2023-09-07</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/jvm/>jvm</a>
<a href=/tags/oom/>oom</a></div><nav class=post-nav><a class=prev href=/post/heap-oom/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">heap-oom</span>
<span class="prev-text nav-mobile">上一篇</span>
</a><a class=next href=/post/dubbo-spi/><span class="next-text nav-default">dubbo spi</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=thend03/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=whenevertobefc@outlook.com class="iconfont icon-email" title=email></a><a href=https://stackoverflow.com/ class="iconfont icon-stack-overflow" title=stack-overflow></a><a href=https://twitter.com/TobeWhenever class="iconfont icon-twitter" title=twitter></a><a href=https://facebook.com class="iconfont icon-facebook" title=facebook></a><a href=https://www.linkedin.com/in/ccc-f-03127a280/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://google.com.hk class="iconfont icon-google" title=google></a><a href=https://github.com/thend03/ class="iconfont icon-github" title=github></a><a href=https://weibo.com/u/2997714233 class="iconfont icon-weibo" title=weibo></a><a href=https://www.zhihu.com/people/sssddr-28 class="iconfont icon-zhihu" title=zhihu></a><a href="https://www.douban.com/people/168584175/?_i=72721742lW80TP" class="iconfont icon-douban" title=douban></a><a href=http://localhost:1313 class="iconfont icon-pocket" title=pocket></a><a href=http://localhost:1313 class="iconfont icon-tumblr" title=tumblr></a><a href=http://localhost:1313 class="iconfont icon-instagram" title=instagram></a><a href=http://localhost:1313 class="iconfont icon-gitlab" title=gitlab></a><a href=http://localhost:1313 class="iconfont icon-bilibili" title=bilibili></a><a href=https://blog.thend03.com/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动
</span><span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span><span class=copyright-year>&copy;
2022 -
2024<span class=heart><i class="iconfont icon-heart"></i></span><span>since</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-GZVCWD04LL"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-GZVCWD04LL")</script></body></html>